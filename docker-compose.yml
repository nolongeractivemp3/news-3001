services:
  php_app:
    image: php:8.3-fpm
    volumes:
      - ./ui:/var/www/html
    environment:
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

  nginx_server:
    image: nginx:alpine
    ports:
      - "3049:80" # Opens the server to the world
    volumes:
      - ./ui:/var/www/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
  backend:
    build: ./server
    command: uv run server.py # Change this from uvicorn to your filenam
    restart: always
    ports:
      - "4567:5000" # important remove later its for testing
    environment:
      POCKETBASE_URL: ${POCKETBASE_URL:-http://pocketbase:8080}
      POCKETBASE_ADMIN_EMAIL: ${POCKETBASE_ADMIN_EMAIL}
      POCKETBASE_ADMIN_PASSWORD: ${POCKETBASE_ADMIN_PASSWORD}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}

  scraper:
    build: ./server
    command: uv run run_scraper.py
    ports:
      - "0987:5001"
    environment:
      POCKETBASE_URL: ${POCKETBASE_URL:-http://pocketbase:8080}
      POCKETBASE_ADMIN_EMAIL: ${POCKETBASE_ADMIN_EMAIL}
      POCKETBASE_ADMIN_PASSWORD: ${POCKETBASE_ADMIN_PASSWORD}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      SERPAPI_API_KEY: ${SERPAPI_API_KEY}
      SCRAPER_TESTING_MODE: ${SCRAPER_TESTING_MODE:-true}
    depends_on:
      - pocketbase

  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    ports:
      - "8080:8080"
    volumes:
      - ./pb_data:/pb_data
    command:
      - serve
      - --http=0.0.0.0:8080
      - --dir=/pb_data
    restart: unless-stopped
